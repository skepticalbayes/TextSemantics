$(document).ready(function(){
    data = [{"count": 5.6, "text": "adolescent disorders treatment", "y": -309.0041809082031, "x": -243.02688598632812, "similar": [{"count": 5.3, "text": "adhd treatment", "score": 0.81, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.47, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.37, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.43, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.42, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.58, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.39, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.62, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.52, "id": 9}], "id": 0}, {"count": 5.3, "text": "adhd treatment", "y": -349.9639892578125, "x": 31.54404640197754, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.81, "id": 0}, {"count": 4.31, "text": "circumcision", "score": 0.32, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.42, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.42, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.37, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.54, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.35, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.61, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.45, "id": 9}], "id": 1}, {"count": 4.31, "text": "circumcision", "y": -18.850540161132812, "x": -369.26153564453125, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.47, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.32, "id": 1}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.21, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.23, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.39, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.52, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.3, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.39, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.48, "id": 9}], "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "y": 216.63058471679688, "x": -225.75686645507812, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.37, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.42, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.21, "id": 2}, {"count": 4.18, "text": "obstetrics problems", "score": 0.45, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.34, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.62, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.42, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.62, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.39, "id": 9}], "id": 3}, {"count": 4.18, "text": "obstetrics problems", "y": -109.50650787353516, "x": 90.2208480834961, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.43, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.42, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.23, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.45, "id": 3}, {"count": 4.35, "text": "malaria", "score": 0.21, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.31, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.24, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.58, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.33, "id": 9}], "id": 4}, {"count": 4.35, "text": "malaria", "y": 94.21943664550781, "x": 261.237548828125, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.42, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.37, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.39, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.34, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.21, "id": 4}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.33, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.45, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.49, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.35, "id": 9}], "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "y": -92.61518859863281, "x": -141.00291442871094, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.58, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.54, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.52, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.62, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.31, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.33, "id": 5}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.41, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.61, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.64, "id": 9}], "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "y": 99.04670715332031, "x": -10.617598533630371, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.39, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.35, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.3, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.42, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.24, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.45, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.41, "id": 6}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.33, "id": 8}, {"count": 4.91, "text": "male infertility impotency", "score": 0.35, "id": 9}], "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "y": -199.97694396972656, "x": 307.1054382324219, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.62, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.61, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.39, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.62, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.58, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.49, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.61, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.33, "id": 7}, {"count": 4.91, "text": "male infertility impotency", "score": 0.41, "id": 9}], "id": 8}, {"count": 4.91, "text": "male infertility impotency", "y": 319.3063049316406, "x": 72.80224609375, "similar": [{"count": 5.6, "text": "adolescent disorders treatment", "score": 0.52, "id": 0}, {"count": 5.3, "text": "adhd treatment", "score": 0.45, "id": 1}, {"count": 4.31, "text": "circumcision", "score": 0.48, "id": 2}, {"count": 4.85, "text": "repair csf rhinorrhea", "score": 0.39, "id": 3}, {"count": 4.18, "text": "obstetrics problems", "score": 0.33, "id": 4}, {"count": 4.35, "text": "malaria", "score": 0.35, "id": 5}, {"count": 5.56, "text": "laparoscopic fibroid removal", "score": 0.64, "id": 6}, {"count": 4.23, "text": "nuclear medicine physician", "score": 0.35, "id": 7}, {"count": 5.66, "text": "vasculitis treatment", "score": 0.41, "id": 8}], "id": 9}]
    var selected_kwd = null;
    var response_data = null;
    var reqData = null;
    var count = 0;
    $(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);
    var options = {
      width: 1180,
      height: 740,
      cloudDomId: '#viz',
      minColor: '#bab8b8',//'#d9d9d9',
      maxColor: '#000000',
      minFontSize: '18',
      maxFontSize: '72',
      xProperty: 'x',
      yProperty: 'y',
    };
    var generateWord2vecCloud = function(options, wordList) {
        const COS_SIM_THRESHOLD = 0.95;
        const MOUSEOVER_TRANSITION_TIME = 400;
        var opacityCircles = 0.7;
        const svgContainerHeight = options.height;

        // add in tf normalization
        const allSum = d3.sum(wordList, function(d) { return parseFloat(d.count, 10); });
        wordList.forEach(function(d, idx) { wordList[idx].tfnorm = d.count / allSum; });
        var sortedWords = wordList.sort(function(a, b) { return b.count - a.count; }); // important to sort so z order is right

          // scales
        var similar_words = sortedWords[0]['similar'];
        console.log(sortedWords);
//        similar_words.sort(function(a, b){ return a.score - b.score}).push({'score': 1});
        var colorExtent = d3.extent(similar_words, function(d) { return d.score; })
        var fullExtent = d3.extent(sortedWords, function(d) { return d.tfnorm; })
        var colorScale = d3.scaleLinear()
                         .domain(fullExtent)
                         .range(['#bdbdbd', '#000000']);
        var blueColorScale = d3.scaleLinear()
                            .domain(fullExtent)
                            .range(['#9ecae1', '#08306b'])
                            //.range(['#b4b4ff', '#0000ff']);
        var orangeColorScale = d3.scaleLinear()
                               .domain(fullExtent)
                               .range(['#fdae6b', '#7f2704'])
        var fontScale = d3.scaleLinear()
                        .domain(fullExtent)
                        .range([options.minFontSize, options.maxFontSize]);
        var blue_color_range = []
        sortedWords.forEach(function(d){
            blue_color_range.push(blueColorScale(d.tfnorm));
        });

        var orange_color_range = []
        sortedWords.forEach(function(d){
            orange_color_range.push(orangeColorScale(d.tfnorm));
        });

        var color_range = []
        var colors = d3.scaleOrdinal().domain(colorExtent).range(["#A07A19", "#AC30C0", "#EB9A72", "#BA86F5", "#EA22A8"]);
        sortedWords.forEach(function(d){
            color_range.push(colors(d.tfnorm));
        });
        var word_radii = []
        sortedWords.forEach(function(d){
            word_radii.push(fontScale(d.tfnorm) + 'px');
        });

        const margin = 200;
        const RADIUS_MARGIN = 0;
        const NUM_CONCENTRIC_CIRCLES = 4;

        const radii = wordList.map(function(d) { return Math.pow(Math.pow(d[options.xProperty], 2) + Math.pow(d[options.yProperty], 2), 0.5); });
        const maxRadius = d3.max(radii);
        const maxDataPoint = wordList[radii.indexOf(maxRadius)];

        // make scales completely symmetric and centered around 0
        var xScale = d3.scaleLinear()
        .domain([-2*maxRadius, 2*maxRadius])
        .range([margin, options.width - margin]);
        var yScale = d3.scaleLinear()
        .domain([-2*maxRadius, 2*maxRadius])
        .range([options.height - margin, margin]);

        const radiusRatios = [1, .75, .5, .25];
        const backgroundColors = ['#fafafa', '#f5f5f5', '#f0f0f0', '#ebebeb'];
        var zoomedIn = false;
        var zoom = d3.zoom()
              .scaleExtent([1, 2])
              .translateExtent([[margin, margin], [options.width - margin, options.height - margin]])
              .extent([[margin, margin], [options.width - margin, options.height - margin]])
              .on("zoom", function() {
                  var transform = d3.event.transform;

                  // update circles and arc tool-tip
                  d3.select('#concentric-circles').attr("transform", transform);
                  d3.select('#arc-tip').attr("transform", transform);

                  // update origin point
                  d3.select('#origin')
                    .attr('cx', function(d) { return transform.applyX(xScale(0)); })
                    .attr('cy', function(d) { return transform.applyY(yScale(0)); });

                  // re-draw text with new scale
                  svg.selectAll('.kwd_circle')
                     .attr('cx', function(d) { return transform.applyX(xScale(d[options.xProperty])); })
                     .attr('cy', function(d) { return transform.applyY(yScale(d[options.yProperty])); });

                  tempXScale = transform.applyX(xScale(0));
                  tempYScale = transform.applyY(yScale(0));

                  // update axes
                  d3.select('#pos-y-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(0)))
                    .attr('y2', transform.applyY(yScale(maxRadius)));
                  d3.select('#pos-x-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(maxRadius)))
                    .attr('y2', transform.applyY(yScale(0)));
                  d3.select('#neg-y-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(0)))
                    .attr('y2', transform.applyY(yScale(-maxRadius)));
                  d3.select('#neg-x-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(-maxRadius)))
                    .attr('y2', transform.applyY(yScale(0)));

                  // 45-degree lines
                  d3.select('#quad-3-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(-maxRadius * Math.cos(Math.PI / 4))))
                    .attr('y2', transform.applyY(yScale(-maxRadius * Math.sin(Math.PI / 4))));
                  d3.select('#quad-1-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(maxRadius * Math.cos(Math.PI / 4))))
                    .attr('y2', transform.applyY(yScale(maxRadius * Math.sin(Math.PI / 4))));
                  d3.select('#quad-2-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(maxRadius * Math.cos(Math.PI / 4))))
                    .attr('y2', transform.applyY(yScale(-maxRadius * Math.sin(Math.PI / 4))));
                  d3.select('#quad-4-axis')
                    .attr('x1', transform.applyX(xScale(0)))
                    .attr('y1', transform.applyY(yScale(0)))
                    .attr('x2', transform.applyX(xScale(-maxRadius * Math.cos(Math.PI / 4))))
                    .attr('y2', transform.applyY(yScale(maxRadius * Math.sin(Math.PI / 4))));
              });
        // create cloud
        var div = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);
        var svg = d3.select(options.cloudDomId)
        .attr('width', options.width)
        .attr('height', options.height);

        svg.call(zoom)
        .on("dblclick.zoom", function() {
//         event.stopPropagation();
         if (zoomedIn) {
          svg.style('cursor', 'default'); // for IE since zoom-in isn't supported
          svg.style('cursor', 'zoom-in');
          svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
          zoomedIn = false;
        } else {
          svg.style('cursor', 'move');
          svg.transition().duration(750).call(zoom.scaleBy, 2);
          zoomedIn = true;
        }
        })
        .append('g');


        var scaledRadius = xScale(0) - yScale(maxRadius) + RADIUS_MARGIN;

        // draw arc 'tooltip'
        var arcContainer = svg.append('g').attr('id', 'arc-tip');
        var arc = d3.arc()
        .innerRadius(0)
        .outerRadius(scaledRadius)
        .startAngle(0)
        .endAngle(Math.acos(COS_SIM_THRESHOLD) * 2);
        arcContainer.append("path")
        .attr('d', arc)
        .attr('id', 'arc')
        .attr('fill', '#f2f2ff')
        .attr('transform', 'translate(' + xScale(0) + ', ' + yScale(0) + ')')
        .style('opacity', 0)
        .style('shape-rendering', 'crispEdges');

        // draw concentric circles
        var circleContainer = svg.append('g').attr('id', 'concentric-circles');
        for (var i = 0; i < NUM_CONCENTRIC_CIRCLES; i++) {
        circleContainer.append("circle")
          .attr('id', 'circle-' + i)
          .attr("cx", xScale(0))
          .attr("cy", yScale(0))
          .attr("r", scaledRadius * radiusRatios[i])
          .attr('stroke', '#efefef')
          .style('fill', 'none')
          .style('shape-rendering', 'crispEdges');

          //.style("fill", backgroundColors[i]);
        }

        // remove default zoom scroll behavior
        svg.on("wheel.zoom", null);
        svg.on("mousewheel.zoom", null);
        svg.on("MozMousePixelScroll.zoom", null);


        // axis polar coord lines
        const lineColor = '#efefef';
        svg.append('svg:line')
        .attr('id', 'pos-y-axis')
        .attr('x1', xScale(0))
        .attr('y1', yScale(0))
        .attr('x2', xScale(0))
        .attr('y2', yScale(maxRadius))
        .style('stroke', lineColor)
        .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
        .attr('id', 'pos-x-axis')
        .attr('x1', xScale(0))
        .attr('y1', yScale(0))
        .attr('x2', xScale(maxRadius))
        .attr('y2', yScale(0))
        .style('stroke', lineColor)
        .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
        .attr('id', 'neg-y-axis')
        .attr('x1', xScale(0))
        .attr('y1', yScale(0))
        .attr('x2', xScale(0))
        .attr('y2', yScale(-maxRadius))
        .style('stroke', lineColor)
        .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
        .attr('id', 'neg-x-axis')
        .attr('x1', xScale(0))
        .attr('y1', yScale(0))
        .attr('x2', xScale(-maxRadius))
        .attr('y2', yScale(0))
        .style('stroke', lineColor)
        .style('shape-rendering', 'crispEdges');

        // 45-degree lines
        svg.append('svg:line')
          .attr('id', 'quad-3-axis')
          .attr('x1', xScale(0))
          .attr('y1', yScale(0))
          .attr('x2', xScale(-maxRadius * Math.cos(Math.PI / 4)))
          .attr('y2', yScale(-maxRadius * Math.sin(Math.PI / 4)))
          .style('stroke', lineColor)
          .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
          .attr('id', 'quad-1-axis')
          .attr('x1', xScale(0))
          .attr('y1', yScale(0))
          .attr('x2', xScale(maxRadius * Math.cos(Math.PI / 4)))
          .attr('y2', yScale(maxRadius * Math.sin(Math.PI / 4)))
          .style('stroke', lineColor)
          .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
          .attr('id', 'quad-2-axis')
          .attr('x1', xScale(0))
          .attr('y1', yScale(0))
          .attr('x2', xScale(maxRadius * Math.cos(Math.PI / 4)))
          .attr('y2', yScale(-maxRadius * Math.sin(Math.PI / 4)))
          .style('stroke', lineColor)
          .style('shape-rendering', 'crispEdges');
        svg.append('svg:line')
          .attr('id', 'quad-4-axis')
          .attr('x1', xScale(0))
          .attr('y1', yScale(0))
          .attr('x2', xScale(-maxRadius * Math.cos(Math.PI / 4)))
          .attr('y2', yScale(maxRadius * Math.sin(Math.PI / 4)))
          .style('stroke', lineColor);

        // Add circle at origin
        svg.append('circle')
        .attr('id', 'origin')
        .attr("cx", xScale(0))
        .attr("cy", yScale(0))
        .attr("r", 5)
        .style("fill", 'black');

        // Add Text Labels
        const sizeRange = { min: options.minFontSize, max: options.maxFontSize };


        const scatterCircles = svg.selectAll('keywords')
        .data(sortedWords)
        .enter()
          .append('circle')
            .attr('class', 'kwd_circle')
            .attr('id', function(d) { return d.id; })
            .style('fill',
            function(d, i) { return color_range[i] })
            .style("opacity", opacityCircles)
            .attr('cx', function(d) { return xScale(d[options.xProperty]); })
            .attr('cy', function(d) { return yScale(d[options.yProperty]); })
            .attr("r", function(d, i) {
              return word_radii[i];
            })
            .on('mouseover', function(d) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div	.html(d.text + "<br/>" + "<br/>" + "count :" + d.count + "<br/>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        var	legendMargin = {left: 5, top: 10, right: 5, bottom: 10},
        legendWidth = 145,
        legendHeight = 490;

        var svgLegend = d3.select("#legend").style('fill', 'none').append("svg")
                    .attr("width", (legendWidth + legendMargin.left + legendMargin.right))
                    .attr("height", (legendHeight + legendMargin.top + legendMargin.bottom));

        var legendWrapper = svgLegend.append("g").attr("class", "legendWrapper")
                        .attr("transform", "translate(" + legendMargin.left + "," + legendMargin.top +")");

        var rectSize = 15, //dimensions of the colored square
            rowHeight = 20, //height of a row in the legend
            maxWidth = 144; //widht of each row


        //Create container per rect/text pair
        var legend = legendWrapper.selectAll('.legendSquare')
                  .data(color_range)
                  .enter().append('g')
                  .attr('class', 'legendSquare')
                  .attr("transform", function(d,i) { return "translate(" + 0 + "," + (i * rowHeight) + ")"; })
                  .style("cursor", "pointer")
                  .on("mouseover", selectLegend(0.02))
                  .on("mouseout", selectLegend(opacityCircles))
                  .on("click", clickLegend);

        //Non visible white rectangle behind square and text for better hover
        legend.append('rect')
              .attr('width', maxWidth)
              .attr('height', rowHeight)
              .style('fill', "white");
        //Append small squares to Legend
        legend.append('rect')
              .attr('width', rectSize)
              .attr('height', rectSize)
              .style('fill', function(d) {return d;});
        //Append text to Legend
        legend.append('text')
              .attr('transform', 'translate(' + 22 + ',' + (rectSize/2) + ')')
              .attr("class", "legendText")
              .style("font-size", "10px")
              .attr("dy", ".35em")
              .text(function(d,i) { return sortedWords[i]['text']; })
              .style('fill', function(d, i) { return color_range[i] });

        //Create g element for bubble size legend
        var bubbleSizeLegend = legendWrapper.append("g")
                                .attr("transform", "translate(" + (legendWidth/2 - 30) + "," + (wordList.length*rowHeight + 20) +")");
        //Draw the bubble size legend
        bubbleLegend(bubbleSizeLegend, xScale, legendSizes = [1e11,3e12,1e13], legendName = "Keyword Cloud");
        function bubbleLegend(wrapperVar, scale, sizes, titleName) {

            var legendSize1 = sizes[0],
                legendSize2 = sizes[1],
                legendSize3 = sizes[2],
                legendCenter = 0,
                legendBottom = 50,
                legendLineLength = 25,
                textPadding = 5,
                numFormat = d3.format(",");

            wrapperVar.append("text")
                .attr("class","legendTitle")
                .attr("transform", "translate(" + legendCenter + "," + 0 + ")")
                .attr("x", 0 + "px")
                .attr("y", 0 + "px")
                .attr("dy", "1em")
                .text(titleName);

            wrapperVar.append("circle")
                .attr('r', scale(legendSize1))
                .attr('class',"legendCircle")
                .attr('cx', legendCenter)
                .attr('cy', (legendBottom-scale(legendSize1)));
            wrapperVar.append("circle")
                .attr('r', scale(legendSize2))
                .attr('class',"legendCircle")
                .attr('cx', legendCenter)
                .attr('cy', (legendBottom-scale(legendSize2)));
            wrapperVar.append("circle")
                .attr('r', scale(legendSize3))
                .attr('class',"legendCircle")
                .attr('cx', legendCenter)
                .attr('cy', (legendBottom-scale(legendSize3)));

            wrapperVar.append("line")
                .attr('class',"legendLine")
                .attr('x1', legendCenter)
                .attr('y1', (legendBottom-2*scale(legendSize1)))
                .attr('x2', (legendCenter + legendLineLength))
                .attr('y2', (legendBottom-2*scale(legendSize1)));
            wrapperVar.append("line")
                .attr('class',"legendLine")
                .attr('x1', legendCenter)
                .attr('y1', (legendBottom-2*scale(legendSize2)))
                .attr('x2', (legendCenter + legendLineLength))
                .attr('y2', (legendBottom-2*scale(legendSize2)));
            wrapperVar.append("line")
                .attr('class',"legendLine")
                .attr('x1', legendCenter)
                .attr('y1', (legendBottom-2*scale(legendSize3)))
                .attr('x2', (legendCenter + legendLineLength))
                .attr('y2', (legendBottom-2*scale(legendSize3)));

            wrapperVar.append("text")
                .attr('class',"legendText")
                .attr('x', (legendCenter + legendLineLength + textPadding))
                .attr('y', (legendBottom-2*scale(legendSize1)))
                .attr('dy', '0.25em')
                .text("$ " + numFormat(Math.round(legendSize1/1e9)) + " B");
            wrapperVar.append("text")
                .attr('class',"legendText")
                .attr('x', (legendCenter + legendLineLength + textPadding))
                .attr('y', (legendBottom-2*scale(legendSize2)))
                .attr('dy', '0.25em')
                .text("$ " + numFormat(Math.round(legendSize2/1e9)) + " B");
            wrapperVar.append("text")
                .attr('class',"legendText")
                .attr('x', (legendCenter + legendLineLength + textPadding))
                .attr('y', (legendBottom-2*scale(legendSize3)))
                .attr('dy', '0.25em')
                .text("$ " + numFormat(Math.round(legendSize3/1e9)) + " B");

        }

        //Decrease opacity of non selected circles when hovering in the legend
        function selectLegend(opacity) {
            return function(d, i) {
                var chosen = sortedWords[i].text;
                d3.select(d3.selectAll('.legendSquare text')['_groups'][0])['_groups'][0][0].forEach(function(txt){
                    if(txt.innerHTML!=chosen){
                        if (d3.select(txt.parentElement).style("visibility") =='visible'){
                            d3.selectAll('.kwd_circle')['_groups'][0].forEach(function(word){
                                if(word.__data__.text!=chosen){
                                    if(d3.select(word).style('visibility')=='visible'){
                                        d3.select(word)
                                            .transition()
                                            .style("opacity", opacity);
                                    }
                                }
                            });
                        }
                    }
                });
                d3.selectAll(".kwd_circle").sort(function (a, b) { // select the parent and sort the path's
                    return b.tfnorm-a.tfnorm;                             // a is the hovered element, bring "a" to the front
                });
            }
        };
        //function selectLegend

        //Function to show only the circles for the clicked sector in the legend
        function clickLegend(d,i) {
            if(d3.select(this).style('visibility')=='visible'){

                d3.selectAll('.legendSquare').style("visibility", 'hidden');
                d3.selectAll('.kwd_circle').style("visibility", 'hidden');
                var chosen = sortedWords[i]['text'];
                d3.selectAll('.kwd_circle')['_groups'][0].forEach(function(word, j){
                    if(word.__data__.text===chosen){
                        d3.select(d3.selectAll('.legendSquare text')['_groups'][0])['_groups'][0][0].forEach(function(txt){
                            if(txt.innerHTML===chosen){
                                d3.select(txt.parentElement).style("visibility", 'visible');
                            }
                        });
                        var offset = Math.acos(COS_SIM_THRESHOLD) * (180 / Math.PI);
                        var currentAngle = Math.atan(Math.abs(word.__data__.y / word.__data__.x)) * (180 / Math.PI);
                        // 1st quadrant
                        if (word.__data__.x > 0 && word.__data__.y > 0) {
                            currentAngle = 90. - currentAngle - offset;
                        }
                        // second quadrant
                        else if (word.__data__.x > 0 && word.__data__.y < 0) {
                            currentAngle = 90. + currentAngle - offset;
                        }
                        // third quadrant
                        else if (word.__data__.x < 0 && word.__data__.y < 0) {
                            currentAngle = -90. - currentAngle - offset;
                        }
                        // fourth quadrant
                        else if (word.__data__.x < 0 && word.__data__.y > 0) {
                            currentAngle = -90. + currentAngle - offset;
                        }

                        d3.select('#arc')
                        .attr('transform', 'translate(' + xScale(0) + ', ' + yScale(0) + ') rotate(' + currentAngle + ')');
                        d3.select('#arc')
                        .style('opacity', 1);

                        if (!d3.select(word).classed('raised')) {
                            // move element to front
                            d3.select(word).raise();
                            d3.select(word).classed('raised', true);
                        }
                        d3.select(word).transition()
    //                        .duration(MOUSEOVER_TRANSITION_TIME)
    //                        .attr('fill', orangeColorScale(d.tfnorm))
                        .attr('r', fontScale(word.__data__.tfnorm))
                        .style('opacity', opacityCircles)
                        .style('visibility', 'visible');
                        var sim_kwds = word.__data__.similar;
                        sim_kwds.sort(function(a, b){
                            return b.score - a.score;
                        });
                        sim_kwds = sim_kwds.slice(0, 3);
                        d3.selectAll('.kwd_circle')['_groups'][0].forEach(function(wrd, ix) {
                            var sim = sim_kwds.filter(function(x) { return x.text === wrd.__data__.text; });
                            if (sim.length > 0 && sim[0].text !== chosen) {
                                d3.select(d3.selectAll('.legendSquare text')['_groups'][0])['_groups'][0][0].forEach(function(txt){
                                    if(txt.innerHTML===wrd.__data__.text){
                                        d3.select(txt.parentElement).style("visibility", 'visible');
                                    }
                                });
                                // check for re-render (IE)
                                if (!d3.select(wrd).classed('raised')) {
                                    // move element to front
                                    d3.select(wrd).raise();
                                    d3.select(wrd).classed('raised', true);
                                }
                                // highlight similar words
                                d3.select(wrd)
                                .transition()
    //                                .duration(MOUSEOVER_TRANSITION_TIME)
                                .attr('r', fontScale(wrd.__data__.tfnorm))
                                .style('opacity', 0.5)
                                .style('visibility', 'visible');
                                //                                .attr('pointer-events', 'none');
                            } else {
                                if (wrd.__data__.text !== chosen) {
                                // check for re-render (IE)
                                d3.select(wrd).classed('raised', false);
                                // fade out all other words
                                d3.select(wrd)
                                  .transition()
    //                                  .duration(MOUSEOVER_TRANSITION_TIME)
                                  .attr('fill', '#e2e2e2')
                                  .style('opacity', 0.02)
                                  .style('visibility', 'hidden');
    //                                  .attr('pointer-events', 'none');
                              }
                            }

                        });

                // check for re-render (IE)

                    }
                });
                d3.selectAll(".kwd_circle").sort(function (a, b) { // select the parent and sort the path's
                    return b.tfnorm-a.tfnorm;                             // a is the hovered element, bring "a" to the front
                });
                event.stopPropagation();
            }
        }



        //Show all the cirkels again when clicked outside legend
        function resetClick() {

            //Activate the mouse over and mouse out events of the legend
            d3.selectAll(".legendSquare")
                .on("mouseover", selectLegend(0.02))
                .on("mouseout", selectLegend(opacityCircles))
                .style("visibility", "visible");

            d3.select('#arc')
                .style('opacity', 0)
                .attr('transform', 'translate(' + xScale(0) + ', ' + yScale(0) + ') rotate(0)');

              // return everything back to normal


            //Show all circles
            d3.selectAll(".kwd_circle")['_groups'][0].forEach(function(word){
                d3.select(word).classed('raised', false);
                d3.select(word).transition().duration(100)
//                  .attr('fill', blueColorScale(word.__data__.tfnorm))
                  .attr('r', fontScale(word.__data__.tfnorm))
                  .style("opacity", opacityCircles)
                  .style("visibility", "visible")
                  .attr('pointer-events', 'auto');

            });
            d3.selectAll(".kwd_circle").sort(function (a, b) { // select the parent and sort the path's
                return b.tfnorm-a.tfnorm;                             // a is the hovered element, bring "a" to the front
            });


        }//resetClick

        //Reset the click event when the user clicks anywhere but the legend
//        d3.select("body").on("click", resetClick);
        $('body').click(function(evt){
            if(evt.target.id == "viz"){
                return;
            }
           //For descendants of menu_content being clicked, remove this check if you do not want to put constraint on descendants.
            if($(evt.target).closest('#viz').length){
                return;
            }
            return resetClick();
      //Do processing of click event here for every element except with id menu_content

        });
    };
    var pymChild = new pym.Child();
    pymChild.sendHeight()
    setTimeout(function() { pymChild.sendHeight(); },5000);
    $('#svg-container').html('<svg id="viz" align="center"></svg><div id = "legend" class="col-sm-3" style="padding-right: 0px; padding-left: 0px;"><div class="legendTitle" style="font-size: 12px;">Keyword</div><div class="legendText" style="font-size: 11px; color: #BABABA;">click to select a keyword</div></div>');
    response_data = data
    if(response_data.length>0){
        generateWord2vecCloud(options, response_data);
    }else{
        alert("No keywords with similarity of 0.9 exist in the cropus")
    }
});